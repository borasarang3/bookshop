<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/layout}">
<head>
    <meta charset="UTF-8">
    <title>카테고리</title>
</head>
<body>

<div layout:fragment="content">

    <h1 class="fw-bold">카테고리</h1>
    <p>
        카테고리 목록 및 수정을 할 수 있습니다.
        <br>
        카테고리 내의 상품 관리도 가능합니다.
    </p>


    <ul class="list-group">
        <li class="list-group-item list-group-item-action d-flex justify-content-between align-items-start">
            <div class="ms-2 m-auto">
                <div class="fw-bold">분류</div>
            </div>
            <button type="button" class="btn btn-outline-secondary btn-sm addBtn"
                    data-bs-toggle="modal" data-bs-target="#new-modal">추가</button>
        </li>
        <!--관리는 상품을 만들고나서 구현하기-->
        <!--상품 만들고 나서 카테고리에 속한 상품 수를 (1) 형태로 이름 옆에 적기-->
        <li class="list-group-item d-flex list-group-item-action justify-content-between align-items-start"
        th:each="dto: ${categoryDTOList}">
            <div class="ms-2 m-auto">
                <div>[[${dto.cname}]]</div>
            </div>
            <button type="button" class="btn btn-outline-secondary btn-sm me-md-2 managBtn"
                    data-bs-toggle="modal" data-bs-target="#new-modal">관리</button>
            <button type="button" class="btn btn-outline-secondary btn-sm me-md-2 modiBtn"
                    data-bs-toggle="modal" data-bs-target="#new-modal">수정</button>
            <button type="button" class="btn btn-outline-secondary btn-sm removBtn">삭제</button>
        </li>

    </ul>


    <div class="modal" id="new-modal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title fw-bold">카테고리 관리</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="categoryName" class="form-label fw-bold">카테고리 이름</label>
                        <input type="text" name="cname" class="form-control" id="categoryName" required>
                        <input type="hidden" name="cname1" class="form-control" id="categoryName1" readonly>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary regiBtn">등록</button>
                    <button type="button" class="btn btn-outline-secondary updBtn">수정</button>
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">취소</button>
                </div>
            </div>
        </div>
    </div>






</div>

<script layout:fragment="script" th:inline="javascript">

    $(document).ready(function () {
        let modal = $("#new-modal"); // 모달 전체
        let listGroup = $(".list-group-item");
        let modalTitle = $(".modal-title"); //모달 제목

        let addBtn = $(".addBtn"); // 추가 버튼
        let managBtn = $(".managBtn"); // 관리 버튼
        let modiBtn = $(".modiBtn"); // 수정 버튼
        let removBtn = $(".removBtn"); // 삭제 버튼

        let regiBtn = $(".regiBtn"); // 등록 실행 버튼
        let updBtn = $(".updBtn"); // 수정 실행 버튼

        let categoryName = $("#categoryName") // input창
        let categoryName1 = $("#categoryName1") // hidden input창 수정할 때 사용

        categoryName.val("");

        //처음에는 숨겨져 있다가 마우스를 올리면
        // 해당 행의 버튼만 보이도록
        // addBtn.hide();
        // managBtn.hide();
        // modiBtn.hide();
        // removBtn.hide();
        //
        // listGroup.on("mouseover", function (){
        //     addBtn.show();
        //     managBtn.show();
        //     modiBtn.show();
        //     removBtn.show();
        // })


        //모달창을 여는 버튼의 텍스트가 추가, 관리, 수정일 경우
        //스토리보드를 참조하여 각 텍스트에 맞는 형태로 모달창을 띄우고
        //해당 기능에 알맞은 기능을 적용하기

        //추가 버튼을 눌렀을 때
        addBtn.on("click", function () {
            console.log(addBtn.text()) //버튼 text 가져오기

            if (addBtn.text() == "추가"){
                regiBtn.show();
                updBtn.hide();
                categoryName.val("");
            }
        })

        //등록 버튼을 눌렀을 때
        regiBtn.on("click", function () {
            console.log(categoryName.val());

            $.ajax({
                url : "/category/register",
                type : "post",
                data : {"cname" : categoryName.val()},
                dataType : "text",
                success : function (result){

                    if (result.toString() == "a"){
                        alert("이미 등록된 카테고리입니다.")

                    } else if (result.toString() == "b"){
                        alert("카테고리가 등록되었습니다.")

                        modal.modal("hide");
                        categoryName.val("");
                        location.reload();
                    }

                },
                error : function (result){
                    console.log(result.responseText)
                }
            })
        })

        //수정 버튼을 눌렀을 때
        modiBtn.on("click", function () {
            console.log($(this).text()) //버튼 text 가져오기

            if ($(this).text() == "수정"){
                regiBtn.hide();
                updBtn.show();
                let selectC = $(this).closest('li.list-group-item'); // 선택한 카테고리 이름
                categoryName.val(selectC.find('div:first-child div').text().trim())
                categoryName1.val(selectC.find('div:first-child div').text().trim())
            }
        })

        //모달창의 수정 버튼을 눌렀을 때
        updBtn.on("click", function (){
            console.log(categoryName.val());

            $.ajax({
                url : "/category/modify",
                type : "put",
                data : {"cname" : categoryName.val(),
                        "cname1" : categoryName1.val()},
                dataType : "text",
                success : function (result){

                    if (result.toString() == "a"){
                        alert("이미 등록된 카테고리입니다.")

                    } else if (result.toString() == "b"){
                        alert("카테고리가 수정되었습니다.")

                        modal.modal("hide");
                        categoryName.val("");
                        location.reload();
                    }

                },
                error : function (result){
                    console.log(result.responseText)
                }
            })
        })

        //삭제 버튼을 눌렀을 때
        removBtn.on("click", function (){
            let selectC = $(this).closest('li.list-group-item'); // 선택한 카테고리 이름
            let category = selectC.find('div:first-child div').text().trim();
            console.log(category)

            $.ajax({
                url : "/category/remove",
                type : "delete",
                data : {"cname" : category},
                dataType : "text",
                success : function (result){

                    alert("카테고리가 삭제되었습니다.")

                    categoryName.val("");
                    location.reload();

                },
                error : function (result){
                    console.log(result.responseText)
                }
            })

        })





    })


</script>


</body>
</html>